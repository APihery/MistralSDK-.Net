# Pen-Test Analysis ‚Äì Mistral SDK .NET

This document summarizes the security analysis (pen-test) of the Mistral .NET SDK and recommended adversarial tests.

## 1. Current test coverage

### ‚úÖ Tests already in place

| Domain | Tests | Status |
|--------|-------|--------|
| **Audio** | Path traversal, name too long, invalid characters, relative/file:// URL, URL too long | ‚úÖ |
| **Reasoning** | Null chunks, ThinkChunk null, null model/message | ‚úÖ |
| **Constructor** | ApiKey null/empty/whitespace | ‚úÖ |
| **Chat** | Null request, cancellation | ‚úÖ |
| **Files** | Null stream, empty name, invalid purpose, empty fileId | ‚úÖ |
| **OCR** | Null request, null document | ‚úÖ |
| **Content** | MessageContentConverter null, unknown types | ‚úÖ |

### ‚ö†Ô∏è Identified gaps

| Vulnerability | Risk | Recommendation |
|---------------|------|----------------|
| **Client after Dispose** | `ObjectDisposedException` not documented | Test and document behavior |
| **Malformed JSON (200 OK)** | Unhandled `JsonException` (Files, OCR, Audio) | Test + wrap in try/catch or document |
| **Stream throws on Read** | `IOException` during `FilesUploadAsync` | Test correct propagation |
| **OCR URL file://** | No validation ‚Äì SSRF risk if API follows URL | Validate http/https scheme |
| **OCR invalid base64** | Possible corrupted data submission | Test `FromImageBase64` with invalid base64 |
| **FileId path traversal** | `file-../../../etc/passwd` ‚Äì `Uri.EscapeDataString` protects | Verify API rejects |
| **Malicious BaseUrl** | `javascript:`, `file://` ‚Äì `MistralClientOptions.Validate()` checks http/https | ‚úÖ Protected |
| **Stream closed before upload** | `ObjectDisposedException` | Test |
| **Concurrent Dispose** | Double dispose ‚Äì idempotent | Verify |
| **Very large payload** | Possible OOM | Limit or document |

## 2. Additional attack vectors

### 2.1 Streams

- **Non-readable stream**: `CanRead = false` ‚Üí `StreamContent` may fail
- **Stream throws after first byte**: Simulate network error during upload
- **Already closed stream**: `ObjectDisposedException` when sending

### 2.2 Malformed inputs

- **Partial JSON**: `{"model":"` ‚Üí `JsonException`
- **Empty JSON**: `{}` or `""` ‚Üí Define behavior
- **Unicode/emoji in fileId**: `file-üòÄ` ‚Üí Verify URL remains valid

### 2.3 Resources

- **Integration tests**: Use files from `Ressources/`:
  - `test_ocr_image_1.jpg` as audio ‚Üí Expected rejection
  - `test_ocr_fr_en.pdf` as audio ‚Üí Expected rejection
  - Corrupted file (truncated) ‚Üí Expected error

### 2.4 Network behavior

- **Timeout**: `TaskCanceledException` ‚Üí Already handled
- **Cancellation**: `OperationCanceledException` ‚Üí Already tested
- **Empty HTTP response**: `Content-Length: 0` ‚Üí `ReadAsStringAsync` returns `""`

## 3. Recommendations

1. **Adversarial tests**: Add the tests listed above for uncovered cases.
2. **Documentation**: Specify in `error-handling.md` the possible exceptions (`JsonException`, `ObjectDisposedException`).
3. **OCR validation**: Add URL validation (http/https) for `OcrDocument.FromDocumentUrl` and `FromImageUrl` if the API follows the URL server-side.
4. **JSON robustness**: Consider try/catch around `JsonSerializer.Deserialize` in Files/OCR/Audio to avoid unhandled `JsonException`.

## 4. References

- `api-key.txt`: API key for integration tests
- `Ressources/`: Test files (audio, images, PDF)
- `TestConfiguration.GetTestApiKey()`: Load test keys
